# SYNOPSIS:
#
#   make [all | examples] - makes examples
#   make performance      - makes performance measurement tests
#   make tests            - makes unit tests
#   make clean            - removes all files generated by make except executable
#   make cleaneast        - removes all files generated by make including executable

BASE_DIRECTORY        = ..
HEADERS              += -I$(BASE_DIRECTORY)/src/include
HEADERS              += -I$(BASE_DIRECTORY)/contrib/asio/asio/include
HEADERS_GTEST        += $(HEADERS)
HEADERS_GTEST        += -I$(BASE_DIRECTORY)/contrib/googletest/googlemock/include
HEADERS_GTEST        += -I$(BASE_DIRECTORY)/contrib/googletest/googletest/include
SYMBOLS              += -DASIO_STANDALONE
EXECUTABLE            = conwrap

CXX_OPTIONS          += -std=c++1y -c -O3 -g0 -Wall -fmessage-length=0 -Wno-reorder -Wno-unused -pthread
CXX_FLAGS            += $(SYMBOLS) $(HEADERS) $(CXX_OPTIONS)
CXX_FLAGS_GTEST      += $(SYMBOLS) $(HEADERS_GTEST) $(CXX_OPTIONS)

LD_DIRECTORIES       +=
LD_DIRECTORIES_GTEST += $(LD_DIRECTORIES)
LD_DIRECTORIES_GTEST += -L$(BASE_DIRECTORY)/contrib/googletest/build/googlemock
LD_DIRECTORIES_GTEST += -L$(BASE_DIRECTORY)/contrib/googletest/build/googletest
LD_LIBRARIES         += -lpthread
LD_LIBRARIES_GTEST   += $(LD_LIBRARIES)
LD_LIBRARIES_GTEST   += -lgmock -lgtest
LD_OPTIONS           += -s
LD_FLAGS             += $(LD_DIRECTORIES) $(LD_LIBRARIES) $(LD_OPTIONS)
LD_FLAGS_GTEST       += $(LD_DIRECTORIES_GTEST) $(LD_LIBRARIES_GTEST) $(LD_OPTIONS)

all : examples

clean :
	rm -f *.o

cleanest : clean
	rm $(EXECUTABLE)

examples : examples_link clean

examples_link : examples_main
	$(CXX) -o $(EXECUTABLE) main.o $(LD_FLAGS)

examples_main :
	$(CXX) -o main.o $(BASE_DIRECTORY)/examples/main.cpp $(CXX_FLAGS)

performance : performance_link clean

performance_link : performance_main
	$(CXX) -o $(EXECUTABLE) main.o $(LD_FLAGS)

performance_main :
	$(CXX) -o main.o $(BASE_DIRECTORY)/performance/main.cpp $(CXX_FLAGS)

Processor.o :
	$(CXX) -o Processor.o $(BASE_DIRECTORY)/test/conwrap/Processor.cpp $(CXX_FLAGS_GTEST)

ProcessorAsio.o :
	$(CXX) -o ProcessorAsio.o $(BASE_DIRECTORY)/test/conwrap/ProcessorAsio.cpp $(CXX_FLAGS_GTEST)

ProcessorCommon.o :
	$(CXX) -o ProcessorCommon.o $(BASE_DIRECTORY)/test/conwrap/ProcessorCommon.cpp $(CXX_FLAGS_GTEST)

ProcessorQueue.o :
	$(CXX) -o ProcessorQueue.o $(BASE_DIRECTORY)/test/conwrap/ProcessorQueue.cpp $(CXX_FLAGS_GTEST)

tests : tests_link clean

tests_link : tests_main Processor.o ProcessorAsio.o ProcessorCommon.o ProcessorQueue.o
	$(CXX) -o $(EXECUTABLE) main.o Processor.o ProcessorAsio.o ProcessorCommon.o ProcessorQueue.o $(LD_FLAGS_GTEST)

tests_main :
	$(CXX) -o main.o $(BASE_DIRECTORY)/test/main.cpp $(CXX_FLAGS_GTEST)
